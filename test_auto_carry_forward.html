<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto Carry Forward System - Test & Verification</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-light">
    <div class="container py-5">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="fas fa-check-circle me-2"></i>Auto Carry Forward System - Test & Verification</h4>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle me-2"></i>System Status</h6>
                    <ul class="mb-0">
                        <li>Database migration: <strong>Run migrate_subscription_tracking.sql</strong></li>
                        <li>Frontend updated: <strong>index.html & index.php</strong></li>
                        <li>Backend updated: <strong>handler_clients.php</strong></li>
                        <li>Automated checking: <strong>Runs on page load</strong></li>
                    </ul>
                </div>

                <h5 class="mt-4">Test Steps:</h5>
                <div class="accordion" id="testAccordion">
                    <!-- Step 1 -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#step1">
                                <i class="fas fa-database me-2"></i>Step 1: Run Database Migration
                            </button>
                        </h2>
                        <div id="step1" class="accordion-collapse collapse show" data-bs-parent="#testAccordion">
                            <div class="accordion-body">
                                <p>Open phpMyAdmin and run the SQL file:</p>
                                <pre class="bg-dark text-light p-3 rounded">migrate_subscription_tracking.sql</pre>
                                <p>This will add the following columns to clients table:</p>
                                <ul>
                                    <li><code>subscription_months</code> (INT, default 12)</li>
                                    <li><code>subscription_start_date</code> (DATE)</li>
                                    <li><code>subscription_end_date</code> (DATE)</li>
                                    <li><code>last_carry_forward_date</code> (DATE)</li>
                                </ul>
                                <button class="btn btn-success" onclick="checkDatabase()">
                                    <i class="fas fa-check me-2"></i>Verify Database
                                </button>
                                <div id="dbResult" class="mt-3"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2 -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#step2">
                                <i class="fas fa-user-plus me-2"></i>Step 2: Test New Client Creation
                            </button>
                        </h2>
                        <div id="step2" class="accordion-collapse collapse" data-bs-parent="#testAccordion">
                            <div class="accordion-body">
                                <p>Create a new test client with these settings:</p>
                                <ul>
                                    <li><strong>Company Name:</strong> Test Carry Forward Client</li>
                                    <li><strong>Renewal Date:</strong> <span class="badge bg-warning">Yesterday's date</span></li>
                                    <li><strong>Subscription Duration:</strong> 2 months</li>
                                    <li><strong>Package Credits:</strong> 40</li>
                                </ul>
                                <p><strong>Expected Result:</strong> Client should be created with subscription_end_date = renewalDate + 2 months</p>
                                <a href="index.php" class="btn btn-primary" target="_blank">
                                    <i class="fas fa-external-link-alt me-2"></i>Open CMS
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3 -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#step3">
                                <i class="fas fa-sync-alt me-2"></i>Step 3: Test Auto Carry Forward
                            </button>
                        </h2>
                        <div id="step3" class="accordion-collapse collapse" data-bs-parent="#testAccordion">
                            <div class="accordion-body">
                                <p>After creating the test client:</p>
                                <ol>
                                    <li>Reload the page (F5)</li>
                                    <li>Open browser console (F12)</li>
                                    <li>Look for: <code>âœ… Auto Carry Forward: X client(s) processed</code></li>
                                    <li>Check client details - renewal date should move forward 1 month</li>
                                    <li>Unused credits should be in "Carried Forward Credits"</li>
                                </ol>
                                <button class="btn btn-info" onclick="testCarryForward()">
                                    <i class="fas fa-play me-2"></i>Test Carry Forward API
                                </button>
                                <div id="carryForwardResult" class="mt-3"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 4 -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#step4">
                                <i class="fas fa-calendar-times me-2"></i>Step 4: Test Subscription Expiry
                            </button>
                        </h2>
                        <div id="step4" class="accordion-collapse collapse" data-bs-parent="#testAccordion">
                            <div class="accordion-body">
                                <p>To test that carry forward stops after subscription expires:</p>
                                <ol>
                                    <li>Manually update test client's <code>subscription_end_date</code> to yesterday in phpMyAdmin</li>
                                    <li>Reload the page</li>
                                    <li>Carry forward should NOT process for this client</li>
                                    <li>Console should show 0 clients processed</li>
                                </ol>
                                <pre class="bg-dark text-light p-3 rounded">UPDATE clients SET subscription_end_date = DATE_SUB(CURDATE(), INTERVAL 1 DAY) WHERE company_name = 'Test Carry Forward Client';</pre>
                            </div>
                        </div>
                    </div>

                    <!-- Step 5 -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#step5">
                                <i class="fas fa-list-check me-2"></i>Step 5: Verification Checklist
                            </button>
                        </h2>
                        <div id="step5" class="accordion-collapse collapse" data-bs-parent="#testAccordion">
                            <div class="accordion-body">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="check1">
                                    <label class="form-check-label" for="check1">
                                        Database migration completed successfully
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="check2">
                                    <label class="form-check-label" for="check2">
                                        "Subscription Duration" field appears in Add/Edit Client modals
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="check3">
                                    <label class="form-check-label" for="check3">
                                        Auto Carry Forward System card removed from dashboard
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="check4">
                                    <label class="form-check-label" for="check4">
                                        Carry forward runs automatically on page load
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="check5">
                                    <label class="form-check-label" for="check5">
                                        Credits carry forward correctly for eligible clients
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="check6">
                                    <label class="form-check-label" for="check6">
                                        Carry forward stops after subscription expires
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="alert alert-success mt-4">
                    <h6><i class="fas fa-lightbulb me-2"></i>Key Features</h6>
                    <ul class="mb-0">
                        <li><strong>Silent Operation:</strong> No user intervention required</li>
                        <li><strong>Subscription-Based:</strong> Automatically stops after duration</li>
                        <li><strong>Date Tracking:</strong> Prevents duplicate processing</li>
                        <li><strong>Console Logging:</strong> Check browser console for processing details</li>
                        <li><strong>Renewable:</strong> Edit client to extend subscription duration</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        async function checkDatabase() {
            const resultDiv = document.getElementById('dbResult');
            resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm"></div> Checking...';
            
            try {
                const response = await fetch('check_database.php');
                const result = await response.json();
                
                if (result.success) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>Database is ready!</strong> All required columns exist.
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            <strong>Migration needed:</strong> ${result.message}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Could not check database. Please verify manually in phpMyAdmin.
                    </div>
                `;
            }
        }

        async function testCarryForward() {
            const resultDiv = document.getElementById('carryForwardResult');
            resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm"></div> Running carry forward...';
            
            try {
                const response = await fetch('handler_clients.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'auto_carry_forward' })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    let html = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>Success!</strong> Processed ${result.processed_count} client(s).
                        </div>
                    `;
                    
                    if (result.results && result.results.length > 0) {
                        html += '<table class="table table-sm table-bordered mt-2"><thead><tr><th>Client</th><th>Carried Forward</th><th>New Renewal</th></tr></thead><tbody>';
                        result.results.forEach(r => {
                            html += `<tr><td>${r.client_name}</td><td>${r.carried_forward} credits</td><td>${r.new_renewal_date}</td></tr>`;
                        });
                        html += '</tbody></table>';
                    }
                    
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-danger">${result.message}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>
